---

- name: get_cluster_hosts_state/esxifree | Get basic instance info of all vms
  vmware_vm_info:
    username: "{{ cluster_vars.username }}"
    password: "{{ cluster_vars.password }}"
    hostname: "{{ cluster_vars.esxi_ip }}"
    validate_certs: no
  register: r__vmware_vm_info
  delegate_to: localhost
  run_once: true

- name: get_cluster_hosts_state/esxifree | Get detailed instance info of cluster_name VMs
  vmware_guest_info:
    username: "{{ cluster_vars.username }}"
    password: "{{ cluster_vars.password }}"
    hostname: "{{ cluster_vars.esxi_ip }}"
    validate_certs: no
    datacenter: None
    uuid: "{{item.uuid}}"
  with_items: "{{ r__vmware_vm_info.virtual_machines | to_json | from_json | json_query(\"[?starts_with(guest_name, '\"+cluster_name+\"')]\") }}"
  register: r__vmware_guest_info
  delegate_to: localhost
  run_once: true

## esxifree hosts must use the esxi 'annotations' field as json.  They are stored as unconventional text in the vmx file, so must
## be converted into inline-json within the facts.  If the annotation field is not convertible to json, then we don't consider this VM part of the cluster.
- name: get_cluster_hosts_state/esxifree | update r__vmware_guest_info result with json-parsed annotations
  set_fact:
    r__vmware_guest_info: |
      {% set res = {'results': []} -%}
        {%- for result in r__vmware_guest_info.results -%}
          {%- set loadloose_res = result.instance.annotation | json_loads_loose -%}
          {%- if loadloose_res | type_debug == 'dict' or loadloose_res | type_debug == 'list' -%}
            {%- set _ = result.instance.update({'annotation': loadloose_res}) -%}
            {%- set _ = res.results.append(result) -%}
          {%- endif -%}
        {%- endfor -%}
      {{ res }}

- name: get_cluster_hosts_state/esxifree | Set cluster_hosts_state
  set_fact:
    cluster_hosts_state: "{{ r__vmware_guest_info.results | json_query(\"[].{name: instance.hw_name, regionzone: None, tagslabels: instance.annotation, instance_id: instance.moid, instance_state: instance.hw_power_status, ipv4: {private: item.ip_address, public: null} }\") }}"
